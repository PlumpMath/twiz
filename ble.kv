#:set color_x (1, 0, 0, 1)
#:set color_y (0, 1, 0, 1)
#:set color_z (0, 0, 1, 1)
#:set red (1, 0, 0, 1)
#:set white (1, 1, 1, 1)
#:set line '48dp'
#:set small_line '32dp'
#:import chain itertools.chain

ScrollView:
    GridLayout:
        size_hint_y: None
        height: self.minimum_height
        cols: 1
        ScanPanel:
            id: scan

        DevicesPanel:
            id: visu

<ScanPanel>:
    height: max(logo.height, box.height)
    orientation: 'vertical'
    size_hint_y: None
    GridLayout:
        id: box
        cols: 1
        size_hint_y: None
        height: self.minimum_height
        ToggleButton:
            text: 'scan'
            id: unfold
            state: 'down'
            size_hint_y: None
            height: self.texture_size[1] + 10

        BoxLayout:
            size_hint_y: None
            height: scrollview.height
            orientation: 'vertical'
            ScrollView:
                id: scrollview
                pos: root.pos
                size_hint_y: None
                max_height: '200sp'
                height: min(self.max_height, grid.height) if unfold.state == 'down' else 0
                GridLayout:
                    id: grid
                    cols: 1
                    size_hint_y: None
                    height: self.minimum_height
                    GridLayout:
                        cols: 1
                        size_hint_y: None
                        height: self.minimum_height
                        BoxLayout:
                            size_hint_y: None
                            height: line
                            Label:
                                text: 'address'
                            Label:
                                text: 'id'
                            Label:
                                text: 'power'
                            Label:
                                text: 'activate'
                            Label:
                                text: 'visu'

                    GridLayout:
                        id: results
                        size_hint_y: None
                        height: self.minimum_height
                        cols: 1

            Image:
                id: logo
                source: 'data/logo.png'
                size_hint: None, None
                size: self.texture_size
                top: self.size and root.top - 10
                right: self.size and root.right - 10

<DevicesPanel>:
    height: box.height
    size_hint_y: None
    GridLayout:
        id: box
        cols: 1
        size_hint_y: None
        height: self.minimum_height
        ToggleButton:
            text: 'visu'
            id: unfold
            state: 'down'
            size_hint_y: None
            height: self.texture_size[1] + 10

        ScrollView:
            id: scrollview
            pos: root.pos
            size_hint_y: None
            height: content.height if unfold.state == 'down' else 0

            GridLayout:
                cols: 1
                id: content
                size_hint_y: None
                height: self.minimum_height

<GraphZone>:
    size_hint_y: None
    height: self.minimum_height
    cols: 1
    GridLayout:
        size_hint_y: None
        height: self.minimum_height
        rows: 1
        pos_hint: {'center': (.5, .5)}
        GridLayout:
            size_hint: None, None
            size: self.minimum_size
            cols: 4
            Widget:
            Label:
                text: 'x'
                size_hint: None, None
                size: '48sp', '48sp'
            Label:
                text: 'y'
                size_hint: None, None
                size: self.texture_size
                size: '48sp', '48sp'
            Label:
                text: 'z'
                size_hint: None, None
                size: self.texture_size
                size: '48sp', '48sp'

            Button:
                text: 'euler'
                size_hint: None, None
                size: self.texture_size
                size: '48sp', '48sp'
                on_press: root.focus = 'euler'
            Label:
                text: '%x' % root.device.rx[-1] if root.device else ''
            Label:
                text: '%x' % root.device.ry[-1] if root.device else ''
            Label:
                text: '%x' % root.device.rz[-1] if root.device else ''

            Button:
                text: 'accel'
                size_hint: None, None
                size: self.texture_size
                size: '48sp', '48sp'
                on_press: root.focus = 'accelero'
            Label:
                text: '%x' % root.device.ax[-1] if root.device else ''
            Label:
                text: '%x' % root.device.ay[-1] if root.device else ''
            Label:
                text: '%x' % root.device.az[-1] if root.device else ''

        Graph:
            device: root.device
            focus: root.focus

<Graph>:
    focus: ''
    line_x: {'euler': root.device.rx, 'accelero': root.device.ax}[root.focus] if root.device else [0]
    line_y: {'euler': root.device.ry, 'accelero': root.device.ay}[root.focus] if root.device else [0]
    line_z: {'euler': root.device.rz, 'accelero': root.device.az}[root.focus] if root.device else [0]
    data_len: min(max(map(len, (self.line_x, self.line_y, self.line_z))), 100)
    max_value: 0xffff
    canvas:
        Color:
            rgba: color_x
        Line:
            points:
                chain(*[
                (root.x + x * self.width / root.data_len,
                self.y + self.height * y / root.max_value)
                for x, y in enumerate(root.line_x[-100:])
                ]) if root.data_len and root.max_value and root.line_x else ()
        Color:
            rgba: color_y
        Line:
            points:
                chain(*[
                (root.x + x * self.width / root.data_len,
                self.y + self.height * y / root.max_value)
                for x, y in enumerate(root.line_y[-100:])
                ]) if root.data_len and root.max_value and root.line_y else ()
        Color:
            rgba: color_z
        Line:
            points:
                chain(*[
                (root.x + x * self.width / root.data_len,
                self.y + self.height * y / root.max_value)
                for x, y in enumerate(root.line_z[-100:])
                ]) if root.data_len and root.max_value and root.line_z else ()

<ObjectView>:
    size_hint_y: None
    height: self.minimum_height
    cols: 1
    GraphZone:
        device: root.device
    GridLayout:
        cols: 1 if self.width < 1000 else 2
        id: grid
        size_hint_y: None
        height: self.minimum_height
        GridLayout:
            size_hint_y: None
            orientation: 'vertical'
            height: self.minimum_height
            cols: 1
            OscConfig:
                device: root.device
            MidiConfig:
                device: root.device

        View:
            id: view
            height: 500
            size_hint_x: None
            scene: 'cube.obj'
            size_hint_y: None
            display_all: True
            scene_scale: 4.0
            cam_rotation:
                (
                root.device.rx[-1] * 360. / 0xffff,
                root.device.ry[-1] * 360. / 0xffff,
                root.device.rz[-1] * 360. / 0xffff
                )
            cam_translation: 0, -2, -8
            light_sources:
                {x: ([float(y) * 15 for y in bin(x)[2:].rjust(3, '0')] + [1.0]) for x in range(8)}

<ConfigPanel>:
    cols: 1
    size_hint_y: None
    height: self.minimum_height

<MidiConfig>:
    BoxLayout:
        size_hint_y: None
        height: line
        Label:
            text: 'sensor'
        Label:
            text: 'active'
        Label:
            text: 'event type'
        Label:
            text: 'midi channel'
        Label:
            text: 'event id\n(0-127)'
        Label:
            text: 'event value\n(0-127)'

    GridLayout:
        cols: 1
        id: content
        size_hint_y: None
        height: self.minimum_height

<MidiSensorLine>:
    size_hint_y: None
    height: small_line
    Label:
        text: root.sensor
    CheckBox:
        active: root.active
        on_active: root.active = self.active
    Spinner:
        text: root.signal
        values: ('Note On', 'Note Off', 'Note Aftertouch', 'Controller')
        on_text: root.signal = self.text

    Spinner:
        text: root.chan
        values: ('%s' % x for x in range(16))
        on_text: root.chan = self.text

    TextInput:
        text: root.event_id
        on_text_validate: root.event_id = self.text

    TextInput:
        text: root.event_value
        on_text_validate: root.event_value = self.text

<OscConfig>:
    BoxLayout:
        size_hint_y: None
        height: '48sp'
        Label:
            text: 'ip'
        Label:
            text: 'port'
        Label:
            text: 'address'
        Label:
            text: 'content'
        Label:
            text: 'delete'

    GridLayout:
        cols: 1
        id: content
        size_hint_y: None
        height: self.minimum_height

    Button:
        text: '+'
        size_hint_y: None
        height: '48sp'
        visible: len(content.children) < 6
        opacity: 1 if self.visible else 0
        disabled: not self.visible
        on_press: root.add_line()

<OscConfigLine>:
    size_hint_y: None
    height: small_line
    TextInput:
        text: root.ip
        on_text: root.ip = self.text

    TextInput:
        text: root.port
        on_text: root.port = self.text
        background_color: white if self.text .isdigit() else red # don't remove the space!

    TextInput:
        text: root.address
        on_text: root.address = self.text
        background_color: white if self.text .startswith('/') else red # don't remove the space!

    TextInput:
        text: root.content
        on_text: root.content = self.text
        background_color: white if all(x in app.sensor_list for x in self.text .split(',')) else red # don't remove the space!


    Button:
        text: 'x'
        on_press: root.config.remove_line(root)

<PloogDevice>:
    size_hint_y: None
    height: line

    BoxLayout:
        pos_hint: {'center': (.5, .5)}
        Label:
            text: root.address
        Label:
            text: root.name
        Label:
            text: '%sdb' % root.power

        CheckBox:
            active: root.active
            on_active: root.active = self.active

        CheckBox:
            active: root.display
            on_active: root.display = self.active

<TextInput>:
    multiline: False
